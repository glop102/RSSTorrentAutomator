<html>
    <head>
        <style>
            table,th,td{
                border: solid 0.1em;
                border-collapse: collapse;
            }
        </style>
        <script>
            async function addDebugTask(){
                behavior = document.getElementById("behaviorType")
                
                bodyData = JSON.stringify({
                    behaviorType: behavior.value
                })
                response = await fetch("/downloads/json/addDebugItem",{
                    method:"POST",
                    headers: [ ["Content-Type", "application/json"] ],
                    body: bodyData
                })
                response = await response.json()

                return false; //do not reload the page
            }
            async function refreshProgress(){
                bar = document.getElementById("progressBar")
                percent = document.getElementById("progressPercentage")
                statusp = document.getElementById("progressStatus")
                speed = document.getElementById("progressSpeed")
                response = await fetch("/downloads/json/progress")
                item = await response.json()
                
                bar.value = item["currentCount"]
                bar.max = item["maxCount"]
                percent.innerText = item["percentage"]*100+"%"
                statusp.innerText = item["status"]
                speed.innerText = item["speed"]
            }
            async function refreshQueueList(){
                table = document.getElementById("queue")
                response = await fetch("/downloads/json/queue")
                items = await response.json()
                html = ""
                for (item of items) {
                    html += "<tr>"
                    for (data in item) {
                        html += "<td>" + String(item[data]).replaceAll("\n", "<br>") + "</td>"
                    }
                    html += "</tr>"
                }
                table.innerHTML = html
            }
            async function refreshFailedList(){
                table = document.getElementById("failures")
                response = await fetch("/downloads/json/failures")
                items = await response.json()
                html=""
                count=0
                for (item of items) {
                    html+="<tr>"
                    for (data in item){
                        html += "<td>" + String(item[data]).replaceAll("\n", "<br>") + "</td>"
                    }
                    html += "<td><button onclick='retryFailedItem("+count+")'>Retry</button></td>"
                    html += "<td><button onclick='deleteFailedItem("+count+")'>Delete</button></td>"
                    //Add in delete and retry buttons
                    html+="</tr>"
                    count++
                }
                table.innerHTML = html
            }
            async function retryFailureList(){
                response = await fetch("/downloads/json/failureRetryAll",{method:"POST"})
                response = await response.json()
            }
            async function clearFailureList(){
                response = await fetch("/downloads/json/failureClearAll",{method:"POST"})
                response = await response.json()
            }
            async function retryFailedItem(index){
                response = await fetch("/downloads/json/failureRetry/"+index,{method:"POST"})
                response = await response.json()
                refreshContents()
            }
            async function deleteFailedItem(index){
                response = await fetch("/downloads/json/failureClear/"+index,{method:"POST"})
                response = await response.json()
                refreshContents()
            }
            async function refreshContents(){
                await refreshProgress()
                await refreshQueueList()
                await refreshFailedList()
            }
            setInterval(refreshContents,2000)
        </script>
    </head>
    <body>
        <h3>Download Status Page</h3>
        <div style="border:solid 0.1em;">
            <p>Debug Items - please do not use without knowing what you are doing</p>
            <form style="border:solid;">
                Host<input type="text" id="host"><br>
                Remote Location<input type="text" id="remoteLocation"><br>
                Local Location<input type="text" id="localLocation"><br>
                <button type="submit">Add Download</button>
            </form>
            <form style="border:solid;" onSubmit="addDebugTask(); return false;">
                Behavior <select id="behaviorType">
                    <option value="Not Actually A Behavior">Not Actually A Behavior</option>
                    <option value="failValidation">failValidation</option>
                    <option value="throwExceptionProcessing">throwExceptionProcessing</option>
                    <option value="throwExceptionValidating">throwExceptionValidating</option>
                    <option value="processInstantly">processInstantly</option>
                    <option value="process1Second">process1Second</option>
                    <option value="process5Seconds">process5Seconds</option>
                    <option value="process30Seconds">process30Seconds</option>
                    <option value="process15Seconds4Times">process15Seconds4Times</option>
                    <option value="raiseStopFlagException">raiseStopFlagException</option>
                    <option value="raiseConnectionException">raiseConnectionException</option>
                </select><br>
                <button type="submit">Add Debug Item</button>
            </form>
        </div>
        <div style="border:solid 0.1em;">
            <p>progress status</p>
            <progress value="0" max="100" id="progressBar"></progress>
            <p id=progressPercentage></p>
            <p id=progressStatus></p>
            <p id=progressSpeed></p>
        </div>
        <div style="border:solid 0.1em;">
            <p>queued items</p>
            <button onclick="refreshQueueList()">Refresh List</button>
            <table id="queue"></table>
        </div>
        <div style="border:solid 0.1em;">
            <p>failed items</p>
            <button onclick="refreshFailedList()">Refresh List</button>
            <button onclick="retryFailureList()">Retry All Items</button>
            <button onclick="clearFailureList()">Clear All Items</button>
            <table id="failures"></table>
        </div>
        <div style="border:solid 0.1em;">
            TODO List<br>
            sort columns<br>
            add column headers<br>
            make the extended debug column collapsable<br>
             - honestly probably have some whitelist columns in a certain order and then tack on the extra columns defaulting to collapsed at the end<br>
            Make it look a bit nicer with some CSS<br>
            seperate out the progress status area so it can be embedded into other things<br>
             - may want to add in one extra detail of what the current item being processed is - perhaps a "description" in the TaskProgress object?<br>
            Support the custom download fields to just test that out<br>
            Make the debug section of the page hidden - perhaps just hidden with css and in the console you can unhide it?<br>
            Make the page refresh interval configurable and pausable<br>
            Add in the file copy and remote delete and http download to finish all the download support before moving on<br>
            Make the auto-update only update while the window is visible<br>
             - at the very least make it drop the interval to something lower when it loses focus<br>
             - <a href="https://stackoverflow.com/questions/1060008/is-there-a-way-to-detect-if-a-browser-window-is-not-currently-active?rq=1">stackoverflow</a><br>
        </div>
        <script>
            refreshContents()
        </script>
    </body>
</html>